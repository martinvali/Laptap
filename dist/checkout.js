(()=>{const e=Stripe("pk_live_51JktFJH7IkGhuWpe9mjCWjoeofyzVsydz5IV1Me7VGTp9x8TOw9GVFRMXxPni6wKArqGPNgmqzZWgLptgywt3PQD00MMcSzpSo",{locale:"et"});let t;function n(e,t,n){document.querySelector(".product-price-value").textContent=`${e} x ${t} = ${n}€`}function o(e){document.querySelector(".transport-price-value").innerText=`${e}€`}function r(e){document.querySelector(".total-price-value").innerText=`${e}€`}function i(){return document.querySelector(".product-quantity")?.value||1}function c(){return document.querySelector("#omniva_select2")?.value||""}function a(){const e=document.querySelector("#omniva_select2");return e.options[e.selectedIndex].innerText||""}async function l(e){try{document.querySelector("#submitBtn").disabled=!0,document.querySelector(".spinner-total-price").classList.remove("hidden"),document.querySelector(".total-price-value").style.display="none";const{signal:e,timeoutId:t}=u(1e4),a=await fetch(`https://laptap.herokuapp.com/payment-intent/prices/${localStorage.getItem("paymentId")}`,{method:"POST",signal:e,mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({quantity:i(),transport:c()})});clearInterval(t);const{unitPrice:l,productsPrice:s,quantity:d,transportPrice:m,totalPrice:p}=await a.json();document.querySelector("#submitBtn").disabled=!1,document.querySelector(".total-price-value").style.display="inline",document.querySelector(".spinner-total-price").classList.add("hidden"),n(d,l,s),o(m),r(p)}catch(e){console.log(e)}}function s(e,t){const n=document.querySelector(".error-msg");n.classList.remove("hidden"),n.querySelector(".error-heading").textContent=e,n.querySelector(".error-text").textContent=t,document.querySelector(".ok-btn").addEventListener("click",(function(){document.querySelector(".error-msg").classList.add("hidden")}))}function u(e){const t=new AbortController;return{signal:t.signal,timeoutId:setTimeout((()=>{t.abort(),console.log("abort"),s("Midagi läks valesti","Palun värskendage lehte, et uuesti proovida")}),e)}}function d(e){e?(document.querySelector("#submitBtn").disabled=!0,document.querySelector("#spinner").classList.remove("hidden"),document.querySelector("#payment-element").classList.add("hidden")):(document.querySelector("#submitBtn").disabled=!1,document.querySelector("#spinner").classList.add("hidden"),document.querySelector("#payment-element").classList.remove("hidden"))}function m(e){console.log(e),e?document.querySelectorAll(".btn-order-2, .btn-order-1").forEach((function(e){e.disabled=!0,e.style.opacity=.6})):e||document.querySelectorAll(".btn-order-2, .btn-order-1").forEach((function(e){e.disabled=!1,e.style.opacity=1}))}new OmnivaWidget({compact_mode:!0,show_offices:!0,custom_html:!1,show_machines:!0,id:2,selection_value:""}),window.addEventListener("load",(function(){const e=document.querySelector("#omniva_select2"),t=document.createElement("option");t.value="tasuta",t.innerText="TASUTA: Tulen ise järgi Tallinna Lilleküla Gümnaasiumisse",e.required=!0,e.setAttribute("form","payment-form"),e.prepend(t),e.value=t,e.addEventListener("change",l)})),async function(){try{document.querySelector("#submitBtn").disabled=!1,document.querySelector(".product-quantity").addEventListener("change",l),d(!0);const{signal:i,timeoutId:c}=u(15e3),a=await fetch("https://laptap.herokuapp.com/payment-intent",{method:"POST",mode:"cors",signal:i,headers:{"Content-Type":"application/json"},body:JSON.stringify({quantity:1,transport:""})});clearInterval(c);const{clientSecret:s,unitPrice:m,productsPrice:p,transportPrice:y,quantity:S,totalPrice:f,id:h}=await a.json();localStorage.setItem("paymentId",h),n(S,m,p),o(y),r(f);const q={theme:"stripe",variables:{colorPrimary:"#63d9b6",colorText:"#495057",fontSizeBase:"10px",borderRadius:"5px",fontFamily:"Poppins, sans-serif",fontWeightNormal:500,spacingUnit:"4px"},rules:{".Label":{fontSize:"1.8rem",fontFamily:"Poppins, sans-serif"},".Input":{fontSize:"1.8rem",fontFamily:"inherit",transition:"all 0.15s"},".input:focus":{border:"2px solid #63d9b6"},".Error":{fontSize:"1.2rem"}}};t=e.elements({appearance:q,clientSecret:s,fonts:[{cssSrc:"https://fonts.googleapis.com/css2?family=Poppins"}]});const v=t.create("payment");v.mount("#payment-element"),v.on("ready",(function(){d(!1)}))}catch(e){console.log(e)}}(),document.querySelector("#payment-form").addEventListener("submit",(async function(n){try{n.preventDefault();const o=document.querySelector("#email").value,r=document.querySelector("#name").value,i=document.querySelector("#phone").value;fetch(`https://laptap.herokuapp.com/payment-intent/metadata/${localStorage.getItem("paymentId")}`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,fullName:r,phone:i,transport:a()})}),m(!0);const{error:c}=await e.confirmPayment({elements:t,confirmParams:{return_url:"https://laptap.herokuapp.com/after-payment",receipt_email:o}});"card_error"===c.type||"validation_error"===c.type?m(!1):(m(!1),s("Midagi läks valesti","Palun värskendage lehte, et uuesti proovida."))}catch(n){s("Midagi läks valesti","Palun värskendage lehte, et uuesti proovida."),console.log(n)}})),document.querySelector(".discount-apply").addEventListener("click",(async function(e){try{e.preventDefault(),document.querySelector(".spinner-total-price").classList.remove("hidden"),document.querySelector(".total-price-value").style.display="none";const{signal:t,timeoutId:a}=u(1e4),l=await fetch(`https://laptap.herokuapp.com/discount-code/${localStorage.getItem("paymentId")}`,{method:"POST",signal:t,mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({quantity:i(),transport:c(),code:document.querySelector(".discount")?.value||""})});clearInterval(a);const s=await l.json();document.querySelector(".total-price-value").style.display="inline",document.querySelector(".spinner-total-price").classList.add("hidden"),document.querySelector("#submitBtn").disabled=!1;const{quantity:d,unitPrice:m,productsPrice:p,transportPrice:y,totalPrice:S,discount:f}=s;n(d,m,p),o(y),r(S),"none"===f?function(){const e=document.querySelector(".discount-price");e.style.visibility="hidden",e.style.position="absolute"}():function(e){const t=document.querySelector(".discount-price");t.style.visibility="visible",t.style.position="relative",document.querySelector(".discount-price-value").innerText=`${e}€`}(f)}catch(e){console.log(e)}}))})();